"
-- sudah revisi HPP 
-- decription tanpa X------------

SELECT 

    CUSTINVOICEJOUR_FIX.INVOICEDATE AS date,
	CUSTTABLE_FIX.ACCOUNTNUM AS [partner_id], 
	CASE WHEN SALESTABLE.SALESPOOLID = 'Mutasi' THEN CUSTINVOICEJOUR_FIX.DELIVERYNAME
	    ELSE CUSTTABLE_FIX.CUSTNAME END AS [partner_name],
	22 as company_id,
	INVENTITEMSUPERGROUP.ITEMSUPERGROUPID as product_category_id,
	INVENTITEMSUPERGROUP.NAME as product_category_name,
	CASE WHEN LEN(INVENTTABLE.ITEMGROUPID) = 8 THEN INVENTTABLE.ITEMGROUPID+'-00'
		ELSE INVENTTABLE.ITEMGROUPID END AS [subproduct_category_id],
	INVENTITEMGROUP.NAME as subproduct_category_name,
	INVENTDIM.INVENTSIZEID as class_id ,
    INVENTDIM.INVENTSIZEID AS class_name,
	INVENTTABLE.ITEMID AS [product_id], 
	INVENTTABLE.ITEMNAME AS [product_name], 
    CUSTINVOICETRANS.SALESUNIT as product_uom,
	CUSTTABLE_FIX.CUSTGROUP AS partner_type_id,
	CUSTGROUP.NAME AS partner_type_name,
    CUSTINVOICETRANS.QTY AS [qty], 
   -- CUSTINVOICETRANS.SALESPRICE AS price, -- SALESPRICE ASLI
	(CUSTINVOICETRANS.LINEAMOUNTMST / CUSTINVOICETRANS.QTY) AS price,
    /*(SELECT ABS(ROUND(REPLACE(CAST(SUM(COSTAMOUNTADJUSTMENT+COSTAMOUNTPOSTED)/CUSTINVOICETRANS.QTY AS BIGINT),'.', ','),1))
        FROM INVENTTRANS AS R
        WHERE   DATAAREA.ID=CUSTINVOICETRANS.DATAAREAID AND
                CUSTINVOICETRANS.SALESID=R.TRANSREFID AND
                CUSTINVOICETRANS.INVENTTRANSID=R.INVENTTRANSID
    ) AS cost,*/
    
      (SELECT SUM(COSTAMOUNTADJUSTMENT+COSTAMOUNTPOSTED) /CUSTINVOICETRANS.QTY
		FROM INVENTTRANS AS R
		WHERE	DATAAREA.ID=CUSTINVOICETRANS.DATAAREAID AND 
				CUSTINVOICETRANS.SALESID=R.TRANSREFID AND 
				CUSTINVOICETRANS.INVENTTRANSID=R.INVENTTRANSID 
				--Z.ITEMID=R.ITEMID AND 
				--Z.INVENTDIMID=R.INVENTDIMID
	   )AS cost,
        ROUND(REPLACE(CAST(CUSTINVOICETRANS.DISCAMOUNT AS BIGINT),'.', ','),1) AS discount,    
	((ROUND(REPLACE(CAST(CUSTINVOICETRANS.QTY * CUSTINVOICETRANS.SALESPRICE  AS BIGINT),'.', ','),1)) - ((SELECT ABS(ROUND(REPLACE(CAST(SUM(COSTAMOUNTADJUSTMENT+COSTAMOUNTPOSTED) AS BIGINT),'.', ','),1))
        FROM INVENTTRANS AS R
        WHERE   DATAAREA.ID=CUSTINVOICETRANS.DATAAREAID AND
                CUSTINVOICETRANS.SALESID=R.TRANSREFID AND
                CUSTINVOICETRANS.INVENTTRANSID=R.INVENTTRANSID
    ))) as margin,
   REPLACE (SALESORIGIN.DESCRIPTION, 'X ------------','' ) AS [description],
 --  SALESORIGIN.DESCRIPTION AS [description],
    CUSTINVOICETRANS.LINEAMOUNTMST AS [price_subtotal], 
        /*(SELECT ABS(ROUND(REPLACE(CAST(SUM(COSTAMOUNTADJUSTMENT+COSTAMOUNTPOSTED) AS BIGINT),'.', ','),1))
        FROM INVENTTRANS AS R
        WHERE   DATAAREA.ID=CUSTINVOICETRANS.DATAAREAID AND
                CUSTINVOICETRANS.SALESID=R.TRANSREFID AND
                CUSTINVOICETRANS.INVENTTRANSID=R.INVENTTRANSID
    ) AS cost_subtotal,*/
    
    (SELECT SUM(COSTAMOUNTADJUSTMENT+COSTAMOUNTPOSTED) 
		FROM INVENTTRANS AS R
		WHERE	DATAAREA.ID=CUSTINVOICETRANS.DATAAREAID AND 
				CUSTINVOICETRANS.SALESID=R.TRANSREFID AND 
				CUSTINVOICETRANS.INVENTTRANSID=R.INVENTTRANSID 
				--Z.ITEMID=R.ITEMID AND 
				--Z.INVENTDIMID=R.INVENTDIMID
	   )AS cost_subtotal,
    CUSTINVOICEJOUR_FIX.INVOICEID AS inv_no,
    CUSTINVOICEJOUR_FIX.INVOICEDATE AS inv_date




FROM  DATABI..CUSTINVOICEJOUR_FIX 
INNER JOIN SALESTABLE ON SALESTABLE.SALESID = CUSTINVOICEJOUR_FIX.SALESID 
INNER JOIN CUSTINVOICETRANS ON CUSTINVOICEJOUR_FIX.DATAAREAID = CUSTINVOICETRANS.DATAAREAID AND --CUSTINVOICEJOUR_FIX.DATAAREAID in (@unitkerja) AND
           CUSTINVOICEJOUR_FIX.INVOICEID <> '' AND CUSTINVOICEJOUR_FIX.INVOICEID = CUSTINVOICETRANS.INVOICEID
INNER JOIN DATABI..CUSTTABLE_FIX ON CUSTINVOICEJOUR_FIX.DATAAREAID = CUSTTABLE_FIX.DATAAREAID AND CUSTINVOICEJOUR_FIX.INVOICEACCOUNT = CUSTTABLE_FIX.ACCOUNTNUM 
INNER JOIN INVENTDIM ON INVENTDIM.INVENTDIMID = CUSTINVOICETRANS.INVENTDIMID AND INVENTDIM.DATAAREAID ='VIRT' 
INNER JOIN INVENTTABLE ON INVENTTABLE.ITEMID = CUSTINVOICETRANS.ITEMID AND INVENTTABLE.DATAAREAID ='VIRT' 
INNER JOIN DATAAREA ON DATAAREA.ID = CUSTINVOICEJOUR_FIX.DATAAREAID
INNER JOIN INVENTDIMGROUP ON INVENTDIMGROUP.DIMGROUPID=INVENTTABLE.DIMGROUPID AND INVENTDIMGROUP.DATAAREAID='VIRT'
INNER JOIN SALESORIGIN ON SALESORIGIN.ORIGINID = SALESTABLE.SALESORIGINID AND SALESORIGIN.DATAAREAID='VIRT'
INNER JOIN CUSTGROUP ON CUSTGROUP.CUSTGROUP = CUSTTABLE_FIX.CUSTGROUP AND CUSTGROUP.DATAAREAID='VIRT'
INNER JOIN INVENTITEMGROUP ON INVENTITEMGROUP.ITEMGROUPID = INVENTTABLE.ITEMGROUPID AND INVENTITEMGROUP.DATAAREAID='VIRT'
INNER JOIN INVENTITEMSUPERGROUP ON INVENTITEMSUPERGROUP.ITEMSUPERGROUPID = INVENTITEMGROUP.ITEMSUPERGROUPID AND INVENTITEMSUPERGROUP.DATAAREAID='VIRT'
--WHERE CUSTINVOICEJOUR_FIX.INVOICEDATE BETWEEN ('01/20/2022') AND ('01/22/2022') AND 
WHERE LEFT(CONVERT(varchar,CUSTINVOICEJOUR_FIX.INVOICEDATE,112),6) = '202202' AND
--WHERE LEFT(CONVERT(varchar,CUSTINVOICEJOUR_FIX.INVOICEDATE,112),6) = '"+((String)globalMap.get("ym"))+"'  AND
CUSTTABLE_FIX.ISINTERCOMPANY = ('0') --AND 
--INVENTTABLE.DIMGROUPID IN (@GROUPID) AND
--SALESTABLE.SALESORIGINID IN (@ORIGIN) 
GROUP BY 

	CONVERT(VARCHAR,CUSTINVOICEJOUR_FIX.INVOICEDATE,103),
	CUSTTABLE_FIX.ACCOUNTNUM, 
	CASE WHEN SALESTABLE.SALESPOOLID = 'Mutasi' THEN CUSTINVOICEJOUR_FIX.DELIVERYNAME
	    ELSE CUSTTABLE_FIX.CUSTNAME END ,
	
	INVENTITEMSUPERGROUP.ITEMSUPERGROUPID ,
	INVENTITEMSUPERGROUP.NAME,
	CASE WHEN LEN(INVENTTABLE.ITEMGROUPID) = 8 THEN INVENTTABLE.ITEMGROUPID+'-00'
		ELSE INVENTTABLE.ITEMGROUPID END ,
	INVENTITEMGROUP.NAME ,
	INVENTDIM.INVENTSIZEID  ,
    INVENTDIM.INVENTSIZEID ,
	INVENTTABLE.ITEMID , 
	INVENTTABLE.ITEMNAME , 
    CUSTINVOICETRANS.SALESUNIT ,
	CUSTTABLE_FIX.CUSTGROUP ,
	CUSTGROUP.NAME ,
    CUSTINVOICETRANS.QTY , 
    CUSTINVOICETRANS.SALESPRICE , 
    CUSTINVOICETRANS.LINEAMOUNTMST , CUSTINVOICETRANS.QTY,
    CUSTINVOICETRANS.DATAAREAID, CUSTINVOICETRANS.SALESID, CUSTINVOICETRANS.INVENTTRANSID,DATAAREA.ID,
        ROUND(REPLACE(CAST(CUSTINVOICETRANS.DISCAMOUNT AS BIGINT),'.', ','),1) ,    
    CUSTINVOICETRANS.DATAAREAID, CUSTINVOICETRANS.SALESID, CUSTINVOICETRANS.INVENTTRANSID,DATAAREA.ID,
    SALESORIGIN.DESCRIPTION ,
    CUSTINVOICETRANS.LINEAMOUNTMST , 
    CUSTINVOICEJOUR_FIX.INVOICEID ,
    CUSTINVOICEJOUR_FIX.INVOICEDATE




"
